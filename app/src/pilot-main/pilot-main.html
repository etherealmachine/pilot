<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/effects/waterfall.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../pilot-controls/pilot-controls.html">
<link rel="import" href="../pilot-list/pilot-list.html">

<dom-module id="pilot-main">
  <template>
    <style>
      :host {
        display: block;
      }
      app-header {
        color: white;
        background-color: var(--paper-blue-500);
      }
      .container {
        margin: 0 10% 0 10%;
      }
      .controls {
        height: 100%;
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-wrap);
      }
      @media (max-width: 800px) {
        app-toolbar {
          @apply(--layout-wrap);
          height: auto;
        }
      }
    </style>

    <iron-ajax
        auto
        id="files-ajax"
        url="/files.json"
        handle-as="json"
        last-response="{{files}}"
        loading="{{loading}}"
        debounce-duration="300">
    </iron-ajax>

    <iron-ajax
        id="controls"
        url="/controls"
        method="POST"
        content-type="application/json"
        handle-as="json"
        on-response="handleResponse">
    </iron-ajax>

    <app-header-layout>

      <app-header fixed condenses effects="waterfall">
        <app-toolbar>
          <paper-menu-button>
            <paper-icon-button
                icon="menu"
                class="dropdown-trigger">
            </paper-icon-button>
            <paper-menu class="dropdown-content">
              <paper-item on-tap="reload">Reload Files</paper-item>
            </paper-menu>
          </paper-menu-button>
          <div title>Pilot</div>
          <pilot-controls
              class="controls"
              playing="[[state.playing]]"
              paused="[[state.paused]]"
              cec-err="[[state.cecErr]]"
              position="[[state.position]]"
              duration="[[state.duration]]"
              on-rpc="onRPC">
          </pilot-controsl>
        </app-toolbar>
      </app-header>

      <pilot-list
          class="container"
          files="[[files]]"
          on-rpc="onRPC"
          on-page="onPage">
      </pilot-list>
    </app-header-layout>

  </template>

  <script src="../../bower_components/moment/min/moment.min.js">
  </script>
  <script>
    Polymer({

      is: 'pilot-main',

      properties: {
        files: Array,
        state: {
          type: Object,
          value: function() {
            return {
              playing: '',
              paused: false,
              cecErr: '',
              position: 0,
              duration: 0
            };
          }
        }
      },

      ready: function() {
        this.rpc('Status');
      },

      reload: function() {
        this.rpc('Reload');
      },

      onRPC: function(event) {
        this.rpc(event.detail.method, event.detail.params);
      },

      onPage: function(event) {
      },

      rpc: function() {
        var params = arguments[1];
        if (!params) {
          params = {};
        }
        this.$.controls.body = {
          method: 'Controls.' + arguments[0],
          params: [params],
          id: 1
        };
        this.$.controls.generateRequest();
      },

      handleResponse: function(resp) {
        var r = resp.target.lastResponse.result;
        this.state = r;
        if (r.num_files) {
          document.getElementById('files-ajax').generateRequest();
        }
      }

    });
  </script>
</dom-module>
